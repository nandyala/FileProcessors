<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:batch="http://www.springframework.org/schema/batch"
       xmlns:batch-int="http://www.springframework.org/schema/batch-integration"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
		http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd http://www.springframework.org/schema/batch-integration http://www.springframework.org/schema/batch-integration/spring-batch-integration.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-file="http://www.springframework.org/schema/integration/file"
       xmlns:task="http://www.springframework.org/schema/task">

    <import resource="classpath*:spring/batch/support/applicationContext.xml"/>
    <import resource="classpath*:spring/batch/jobs/rackMountedDeviceJob.xml"/>

    <bean id="config" class="org.springframework.beans.factory.config.PropertiesFactoryBean">
        <property name="location">
            <value>applicationResources.properties</value>
        </property>
    </bean>

    <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="propertiesArray">
            <list>
                <ref bean="config"/>
            </list>
        </property>
        <property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE"/>
        <property name="order" value="1"/>
        <property name="systemPropertiesMode" value="2"/>
    </bean>

    <int:channel id="inboundFileChannel"/>
    <int:channel id="outboundJobRequestChannel"/>
    <int:channel id="jobLaunchReplyChannel"/>

    <int-file:inbound-channel-adapter id="filePoller"
                                      channel="inboundFileChannel"
                                      directory="file:${input.directory}"
                                      filename-pattern="*.csv">
        <int:poller fixed-rate="10000"/>
    </int-file:inbound-channel-adapter>

    <int:transformer input-channel="inboundFileChannel"
                     output-channel="outboundJobRequestChannel">
        <bean class="com.emerson.batch.launch.FileMessageToJobRequest">
            <property name="fileParameterName" value="input.file.name"/>
            <property name="jobNamesMap" ref="jobNamesMapReference"/>
        </bean>
    </int:transformer>

    <batch-int:job-launching-gateway request-channel="outboundJobRequestChannel"
                                     reply-channel="jobLaunchReplyChannel"/>

    <int:logging-channel-adapter channel="jobLaunchReplyChannel"/>

    <util:map id="jobNamesMapReference" key-type="java.lang.String" value-type="java.lang.String">
    <entry key="RackDevice" value="rackMountedDeviceJob" />
    </util:map>

</beans>
